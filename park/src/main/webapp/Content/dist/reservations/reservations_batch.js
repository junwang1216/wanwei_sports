!function(e,t){var a={tpl:{BlockBooking:function(){return'<tr data-start="#BOOKING_START_DATE#" data-end="#BOOKING_END_DATE#" data-site="#BOOKING_SITE#"><td>#BOOKING_SPORT#</td><td>#BOOKING_START_DATE# ~ #BOOKING_END_DATE#</td><td>#BOOKING_WEEK#</td><td>#BOOKING_START_TIME# ~ #BOOKING_END_TIME#</td><td>#BOOKING_AREA#</td><td><a href="javascript:;" class="btn btn-danger reservations-delete"><span class="glyphicon glyphicon-trash"></span></a></td></tr>'}},opts:{data:{name:"散客",mobile:"",opType:"2",reserveType:"1",reserveModel:"2",siteReserveDateList:[]}},init:function(){e.datetimepicker.setLocale("zh"),e("#block_start_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",minDate:0,value:t().format("YYYY-MM-DD")}),e(".start-date-select").on("click",function(t){t.preventDefault(),e("#block_start_date").datetimepicker("show")}),e("#block_end_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",minDate:0,value:t().format("YYYY-MM-DD")}),e(".end-date-select").on("click",function(t){t.preventDefault(),e("#block_end_date").datetimepicker("show")}),e("#block_time_start").datetimepicker({datepicker:!1,format:"H:i",step:60,value:"06:00"}),e("#block_time_end").datetimepicker({datepicker:!1,format:"H:i",step:60,value:"22:00"}),this.initEvents2(),this.searchMembers()},searchMembers:function(){e("#block_user_phone").autosuggest({url:"/member/searchMember",method:"post",queryParamName:"search",dataCallback:function(t){var a=t.data,o=[];if(1==t.code){if(a&&a.members&&a.members.length>0){for(var n=0;n<a.members.length;n++)o.push({id:a.members[n].memberId,label:a.members[n].memberMobile,value:a.members[n].memberName+"("+a.members[n].memberMobile+")"});return o}return e("#block_user_Id").val(""),e("#block_op_type").val("2"),e("#block_user_name").val("散客"),[]}return alert("搜索会员失败, 请稍后重试"),[]},onSelect:function(t){var a=t.data("label"),o=t.data("id"),n=t.data("value");e("#block_user_phone").val(a),e("#block_user_Id").val(o),e("#block_op_type").val("1"),e("#block_user_name").val(n.replace("("+a+")",""))}}),e(".user-search").on("click",function(t){t.preventDefault();var a=e("#block_user_phone");e.post("member/searchMember",{search:a.val().trim()},function(t){var a=t.data;1==t.code?a&&a.members&&a.members.length>0?(e("#block_user_phone").val(a.members[0].memberMobile),e("#block_user_Id").val(a.members[0].memberId),e("#block_op_type").val("1"),e("#block_user_name").val(a.members[0].memberName)):(e("#block_user_Id").val(""),e("#block_op_type").val("2"),e("#block_user_name").val("散客")):alert("搜索会员失败, 请稍后重试")})})},initEvents2:function(){var t=this;e("#block_user_degree").on("change",function(t){t.preventDefault();var a=e(this),o='<option value="#SITEID#">#SITENAME#</option>';e.post("site/getSiteNames",{sportId:a.val(),siteStatus:"1"},function(t){var a=t.data,n="";if(1==t.code){n+='<option value="">请选择</option>';for(var r=0;r<a.siteNames.length;r++)n+=o.replace("#SITENAME#",a.siteNames[r].siteName).replace("#SITEID#",a.siteNames[r].siteId);e("#block_venue_name").html(n)}else console.log(t.message||"查询场地失败, 请稍后重试"),alert(t.message||"查询场地失败, 请稍后重试")})}),e(".reservations-list").on("click",".reservations-delete",function(a){a.preventDefault();for(var o=e(this).parents("tr"),n=o.attr("data-start"),r=o.attr("data-end"),s=o.attr("data-site"),i=t.opts.data.siteReserveDateList,l=0;l<i.length;l++)if(i[l].reserveStartDate==n&&i[l].reserveEndDate==r&&i[l].siteReserveTimeList[0].siteId==s){t.opts.data.siteReserveDateList.splice(l,1);break}o.remove()}),e(".booking-add").on("click",function(a){function o(){var t=[],a=[];return e('input[name="reserveWeek"]:checked').each(function(){t.push(e(this).val()),a.push(e(this).attr("data-text"))}),{value:t,text:a}}a.preventDefault();var n=e("#reservations_batch_form"),r=e(".reservations-list"),s={};return!!n.valid()&&(s.reserveStartDate=e("#block_start_date").val(),s.reserveEndDate=e("#block_end_date").val(),s.reserveWeek=o().value.join(","),s.siteReserveTimeList=[{siteStartTime:e("#block_time_start").val(),siteEndTime:e("#block_time_end").val(),siteId:e("#block_venue_name").val()}],t.opts.data.siteReserveDateList.push(s),void r.append(t.tpl.BlockBooking().replace("#BOOKING_SPORT#",e("#block_user_degree").find("option:selected").text().trim()).replace("#BOOKING_START_DATE#",e("#block_start_date").val()).replace("#BOOKING_END_DATE#",e("#block_end_date").val()).replace("#BOOKING_START_TIME#",e("#block_time_start").val()).replace("#BOOKING_END_TIME#",e("#block_time_end").val()).replace("#BOOKING_AREA#",e("#block_venue_name").find("option:selected").text().trim()).replace("#BOOKING_WEEK#","("+o().text+")")))}),e(".booking-pay").on("click",function(a){a.preventDefault();var o=e(".reservations-list");if(1==o.find("tr").size())return alert("请先加场"),!1;var n=t.opts.data;n.mobile=e("#block_user_phone").val(),n.name=e("#block_user_name").val(),n.memberId=e("#block_user_Id").val(),n.opType=e("#block_op_type").val(),e.post("site/saveReservationSite",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?(e("#reservations_order_id").val(a.orderId),e("#reservations_order_no").val(a.orderNo),e("#zhifuModal").modal({backdrop:!1,show:!0})):alert(t.message||"提交预订失败, 请稍后重试")})}),e(".reservations-pay-confirm").on("click",function(t){t.preventDefault();var a=e("#reservations_paid_form"),o=a.serialize();return!("submitting"==a.attr("submitting")||!a.valid())&&(a.attr("submitting","submitting"),void e.post("/site/confirmOrder",o,function(t){a.attr("submitting",""),1==t.code?(e("#zhifuModal").modal({backdrop:!1,show:!1}),alert("预订支付成功")):alert(t.message||"确认订单失败, 请稍后重试")}))})},initEvents:function(){var t=this,a=e(".sc-booking-venue"),o=e("#block_pay_type");1==o.val()?(a.find(".booking-pay").parents(".form-group").show(),a.find(".booking-confirm").parents(".form-group").hide()):(a.find(".booking-pay").parents(".form-group").hide(),a.find(".booking-confirm").parents(".form-group").show()),o.on("change",function(e){e.preventDefault(),1==o.val()?(a.find(".booking-pay").parents(".form-group").show(),a.find(".booking-confirm").parents(".form-group").hide()):(a.find(".booking-pay").parents(".form-group").hide(),a.find(".booking-confirm").parents(".form-group").show())});var n=!0;a.on("click",".booking-cancel",function(t){t.preventDefault();var a=e(this),o={fieldnumber:a.parents("tr").attr("data-id")};n&&(n=!1,e.post("/venue/CancelVenueBookingsAdd",o,function(e){200==e.status?a.parents("tr").remove():console.log(e),n=!0}).fail(function(e){console.log(e),n=!0}))});var r=e("#user_venue_info_form");a.on("click",".booking-add",function(o){o.preventDefault();var s=a.find(".sc-booking-venues"),i=r.serialize();n&&r.validate().form()&&(n=!1,e.post("/venue/AddVenueBookings",i,function(a){var o=a.data;200==a.status?(e("#batch_number").val(o.batchnumber),s.append(t.tpl.BlockBooking().replace("#BOOKING_ID#",o.fieldnumber).replace("#BOOKING_SPORT#",e("#block_user_degree").find("option:selected").text().trim()).replace("#BOOKING_START_DATE#",e("#block_start_date").val()).replace("#BOOKING_END_DATE#",e("#block_end_date").val()).replace("#BOOKING_START_TIME#",e("#block_time_start").find("option:selected").text().trim()).replace("#BOOKING_END_TIME#",e("#block_time_end").find("option:selected").text().trim()).replace("#BOOKING_AREA#",e("#block_venue_name").find("option:selected").text().trim()).replace("#BOOKING_WEEK#","("+e("#block_booking_week").find("option:selected").text().trim()+")"))):r.find(".sc-submit-tips").show().html(a.message).addClass("text-danger"),n=!0}).fail(function(e){console.log(e),r.find(".sc-submit-tips").show().html("网络异常, 提交预订失败!!").addClass("text-danger"),n=!0}))})},queryMembers:function(){e(".user-search").on("click",function(t){t.preventDefault();var a=e("#block_user_phone");e.getJSON("/users/Search",{name:a.val().trim()},function(t){var a=t.data;200==t.status?(e('[name="name"]').val(a.name),e('[name="fitphone"]').val(a.phone)):alert(t.message)})})},querySportsArea:function(){e.getJSON("/venue/getVenueSportsArea",{sport:1},function(t){var a=t.data,o="";if(200==t.status){for(var n=0;n<a.length;n++)o+='<option value="'+a[n].sitenumber+'">'+a[n].sitename+"</option>";e("#block_venue_name").html(o)}else alert(t.message)})},bookingVenue:function(){var t=e(".sc-booking-venue"),a=e("#user_venue_info_form"),o=!0;t.on("click",".booking-confirm",function(t){t.preventDefault(),a.find(".sc-submit-tips").hide().removeClass("text-success,text-danger"),o&&(o=!1,e.post("/venue/SubmitVenueBookingsBlock",{batchnumber:e("#batch_number").val()},function(t){var n=t.data;200==t.status?(a.find(".sc-submit-tips").show().html("提交预订成功!!").addClass("text-success"),setTimeout(function(){location.reload()},3e3),e.Web_Print.printBookingSheet(n)):a.find(".sc-submit-tips").show().html(t.message).addClass("text-danger"),o=!0}).fail(function(e){console.log(e),a.find(".sc-submit-tips").show().html("网络异常, 提交预订失败!!").addClass("text-danger"),o=!0}))}),t.on("click",".booking-pay",function(t){t.preventDefault(),a.find(".sc-submit-tips").hide().removeClass("text-success,text-danger"),o&&(o=!1,e.post("/venue/SubmitVenueBookingsBlock",{batchnumber:e("#batch_number").val()},function(t){var n=t.data;200==t.status?(a.find(".sc-submit-tips").show().html("提交预订成功!!").addClass("text-success"),setTimeout(function(){location.reload()},3e3),e.Web_Print.printBookingSheet(n)):a.find(".sc-submit-tips").show().html(t.message).addClass("text-danger"),o=!0}).fail(function(e){console.log(e),a.find(".sc-submit-tips").show().html("网络异常, 提交预订失败!!").addClass("text-danger"),o=!0}))})}};a.init()}(jQuery,moment);