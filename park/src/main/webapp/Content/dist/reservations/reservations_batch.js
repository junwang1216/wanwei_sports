!function(e,t){var a={tpl:{BlockBooking:function(){return'<tr class="reservations-list-item" data-start="#BOOKING_START_DATE#" data-end="#BOOKING_END_DATE#" data-site="#BOOKING_SITE#"><td>#BOOKING_SPORT#</td><td>#BOOKING_START_DATE# ~ #BOOKING_END_DATE#</td><td>#BOOKING_WEEK#</td><td>#BOOKING_START_TIME# ~ #BOOKING_END_TIME#</td><td>#BOOKING_AREA#</td><td><a href="javascript:;" class="btn btn-danger reservations-delete"><span class="glyphicon glyphicon-trash"></span></a></td></tr>'}},opts:{data:{name:"散客",mobile:"",memberId:"0",opType:"2",reserveType:"1",reserveModel:"2",siteReserveDateList:[]}},init:function(){var a=JSON.parse(e.cookie("wc-business-time"));e.datetimepicker.setLocale("zh"),e("#reservations_batch_startDate").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",minDate:0,value:t().format("YYYY-MM-DD")}),e(".start-date-select").on("click",function(t){t.preventDefault(),e("#reservations_batch_startDate").datetimepicker("show")}),e("#reservations_batch_endDate").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",minDate:0,value:t().format("YYYY-MM-DD")}),e(".end-date-select").on("click",function(t){t.preventDefault(),e("#reservations_batch_endDate").datetimepicker("show")}),e("#reservations_batch_start").datetimepicker({datepicker:!1,format:"H:i",allowTimes:a,value:a[0]}),e("#reservations_batch_end").datetimepicker({datepicker:!1,format:"H:i",allowTimes:a,value:a[a.length-1]}),this.initEvents(),this.searchMembers(),this.changePaidMoney()},formatWeek:function(e){var a=t(e).format("e");return"0"!=a?a:7},searchMembers:function(){var t=this;e("#reservations_batch_name").autosuggest({url:"/member/searchMember",method:"post",queryParamName:"search",dataCallback:function(a){var r=a.data,s=[];if(1==a.code){if(r&&r.members&&r.members.length>0){for(var i=0;i<r.members.length;i++)s.push({id:r.members[i].memberMobile,label:r.members[i].memberId,value:r.members[i].memberName+"("+r.members[i].cardTypeName+")"});return s}return e("#reservations_batch_member").val("0"),e("#reservations_batch_opType").val("2"),t.queryMemberBalance(0),[]}return e.logConsole("搜索会员失败",a.message),e.tipsWarningAlert("搜索会员失败"),[]},onSelect:function(a){var r=a.data("label"),s=a.data("id"),i=a.data("value");e("#reservations_batch_member").val(r),e("#reservations_batch_mobile").val(s),e("#reservations_batch_opType").val("1"),e("#reservations_batch_name").val(i.replace(/\(.+\)/,"")),t.queryMemberBalance(r)}})},queryMemberBalance:function(t){return t&&"0"!=t?void e.post("/member/memberDetail",{memberId:t},function(t){var a=t.data,r=e("#reservations_paid_money").val();1==t.code?(e(".reservations-batch-cardMoney").text(a.cardBalance),e("#reservations_paid_balance").val(a.cardBalance),a.cardBalance>=r?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(r-a.cardBalance)):(e.logConsole("会员余额查询失败",t.message),e.tipsWarningAlert("会员余额查询失败"))}):void e("#reservations_paid_balance").val("您还不是会员")},changePaidMoney:function(){e("#reservations_paid_paySumPrice").on("change",function(t){t.preventDefault();var a=e("#reservations_paid_balance").val(),r=e(this).val();a=parseFloat(a).toFixed(2),r=parseFloat(r).toFixed(2),a>=r?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(r-a)})},calculateSiteMoney:function(){var t=this;e.post("/site/calculateSiteMoney",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?(e(".reservations-batch-totalMoney").text(a.originalPrice),e(".reservations-batch-totalNum").text(a.sumNums),e("#reservations_paid_orderSumCount").val(a.sumNums),e("#reservations_paid_orderSumPrice").val(a.originalPrice),e("#reservations_paid_payCount").val(a.sumNums),e("#reservations_paid_paySumPrice").val(a.originalPrice),e("#reservations_paid_money").val(a.originalPrice)):(e.logConsole("计算金额失败",t.message),e.tipsWarningAlert("计算金额失败"))})},initEvents:function(){var t=this;e("#reservations_batch_site").on("change",function(t){t.preventDefault();var a=e(this),r='<option value="#SITEID#">#SITENAME#</option>';e.post("site/getSiteNames",{sportId:a.val(),siteStatus:"1"},function(t){var a=t.data,s="";if(1==t.code){s+='<option value="">请选择</option>';for(var i=0;i<a.siteNames.length;i++)s+=r.replace("#SITENAME#",a.siteNames[i].siteName).replace("#SITEID#",a.siteNames[i].siteId);e("#reservations_batch_siteId").html(s)}else e.logConsole("查询场地失败",t.message),e.tipsWarningAlert("查询场地失败")})}),e(".reservations-list").on("click",".reservations-delete",function(a){a.preventDefault();for(var r=e(this).parents("tr.reservations-list-item"),s=r.attr("data-start"),i=r.attr("data-end"),n=r.attr("data-site"),o=t.opts.data.siteReserveDateList,l=0;l<o.length;l++)if(o[l].reserveStartDate==s&&o[l].reserveEndDate==i&&o[l].siteReserveTimeList[0].siteId==n){t.opts.data.siteReserveDateList.splice(l,1);break}r.remove(),t.calculateSiteMoney()}),e("#reservations_batch_add").on("click",function(a){function r(){var t=[],a=[];return e('input[name="reserveWeek"]:checked').each(function(){t.push(e(this).val()),a.push(e(this).attr("data-text"))}),{value:t,text:a}}a.preventDefault();var s=e("#reservations_batch_form"),i=e(".reservations-list"),n={};if(!s.valid())return!1;var o=t.opts.data;o.mobile=e("#reservations_batch_mobile").val(),o.name=e("#reservations_batch_name").val(),o.memberId=e("#reservations_batch_member").val()||"0",o.opType=e("#reservations_batch_opType").val(),n.reserveStartDate=e("#reservations_batch_startDate").val(),n.reserveEndDate=e("#reservations_batch_endDate").val(),n.reserveWeek=r().value.join(","),n.siteReserveTimeList=[{siteStartTime:e("#reservations_batch_start").val(),siteEndTime:e("#reservations_batch_end").val(),siteId:e("#reservations_batch_siteId").val()}],o.siteReserveDateList.push(n),i.append(t.tpl.BlockBooking().replace(/#BOOKING_SPORT#/g,e("#reservations_batch_site").find("option:selected").text().trim()).replace(/#BOOKING_START_DATE#/g,e("#reservations_batch_startDate").val()).replace(/#BOOKING_END_DATE#/g,e("#reservations_batch_endDate").val()).replace(/#BOOKING_START_TIME#/g,e("#reservations_batch_start").val()).replace(/#BOOKING_END_TIME#/g,e("#reservations_batch_end").val()).replace(/#BOOKING_AREA#/g,e("#reservations_batch_siteId").find("option:selected").text().trim()).replace(/#BOOKING_WEEK#/g,"("+r().text+")")),t.calculateSiteMoney()}),e("#reservations_batch_confirm").on("click",function(a){a.preventDefault();var r=e(".reservations-list"),s=e("#reservations_batch_member").val();return 1==r.find("tr").size()?(alert("请先加场"),!1):(t.queryMemberBalance(s),void e("#pay_modal").modal({backdrop:!1,show:!0}))}),e("#reservations_paid_confirm").on("click",function(a){function r(a){e.post("site/saveReservationSite",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var r=t.data;1==t.code?(e("#reservations_paid_order").val(r.orderId),a()):(e.logConsole("提交预订失败",t.message),e.tipsWarningAlert("提交预订失败"))})}a.preventDefault();var s=e("#reservations_paid_form");return!("submitting"==s.attr("submitting")||!s.valid())&&(s.attr("submitting","submitting"),void r(function(){var t=e("#reservations_paid_form").serialize();e.post("/site/confirmOrder",t,function(t){s.attr("submitting",""),1==t.code?e.tipsSuccessAlert("预订支付成功！",function(){e("#pay_modal").modal("hide"),location.reload()}):(e.logConsole("确认订单失败",t.message),e.tipsWarningAlert("确认订单失败"))})}))})}};a.init()}(jQuery,moment);