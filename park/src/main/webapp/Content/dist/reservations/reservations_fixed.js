!function(e,t){var a={tpl:{BlockBooking:function(){return'<tr class="reservations-list-item" data-date="#BOOKING_START_DATE#" data-site="#BOOKING_SITE#"><td>#BOOKING_SPORT#</td><td>#BOOKING_START_DATE#</td><td>#BOOKING_START_TIME# ~ #BOOKING_END_TIME#</td><td>#BOOKING_AREA#</td><td><a href="javascript:;" class="btn btn-danger reservations-delete"><span class="glyphicon glyphicon-trash"></span></a></td></tr>'}},opts:{data:{name:"散客",mobile:"",memberId:"0",opType:"2",reserveType:"1",reserveModel:"2",siteReserveDateList:[]}},init:function(){e.datetimepicker.setLocale("zh"),e("#reservations_fixed_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",minDate:0,value:t().format("YYYY-MM-DD")}),e(".start-date-select").on("click",function(t){t.preventDefault(),e("#reservations_fixed_date").datetimepicker("show")}),e("#reservations_fixed_start").datetimepicker({datepicker:!1,format:"H:i",step:60,value:"06:00"}),e("#reservations_fixed_end").datetimepicker({datepicker:!1,format:"H:i",step:60,value:"22:00"}),this.initEvents(),this.searchMembers()},formatWeek:function(e){var a=t(e).format("e");return"0"!=a?a:7},searchMembers:function(){var t=this;e("#reservations_fixed_mobile").autosuggest({url:"/member/searchMember",method:"post",queryParamName:"search",dataCallback:function(a){var r=a.data,i=[];if(1==a.code){if(r&&r.members&&r.members.length>0){for(var s=0;s<r.members.length;s++)i.push({id:r.members[s].memberMobile,label:r.members[s].memberId,value:r.members[s].memberName+"("+r.members[s].cardTypeName+")"});return i}return e("#reservations_fixed_member").val("0"),e("#reservations_fixed_name").val("散客"),e("#reservations_fixed_opType").val("2"),t.queryMemberBalance(0),[]}return alert("搜索会员失败, 请稍后重试"),[]},onSelect:function(a){var r=a.data("label"),i=a.data("id"),s=a.data("value");e("#reservations_fixed_member").val(r),e("#reservations_fixed_mobile").val(i),e("#reservations_fixed_opType").val("1"),e("#reservations_fixed_name").val(s.replace(/\(.+\)/,"")),t.queryMemberBalance(r)}})},queryMemberBalance:function(t){return t?void e.post("/member/memberDetail",{memberId:t},function(t){var a=t.data,r=e("#reservations_paid_money").val();1==t.code?(e(".reservations-fixed-cardMoney").text(a.cardBalance),e("#reservations_paid_balance").val(a.cardBalance),a.cardBalance>=r?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(r-a.cardBalance)):alert(t.message||"会员余额查询失败, 请稍后重试")}):void e("#reservations_paid_balance").val("0.00")},calculateSiteMoney:function(){var t=this;e.post("/site/calculateSiteMoney",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?(e(".reservations-fixed-totalMoney").text(a.originalPrice),e(".reservations-fixed-totalNum").text(a.sumNums),e("#reservations_paid_orderSumCount").val(a.sumNums),e("#reservations_paid_orderSumPrice").val(a.originalPrice),e("#reservations_paid_payCount").val(a.sumNums),e("#reservations_paid_paySumPrice").val(a.originalPrice),e("#reservations_paid_money").val(a.originalPrice)):alert(t.message||"计算金额失败, 请稍后重试")})},initEvents:function(){var t=this;e("#reservations_fixed_site").on("change",function(t){t.preventDefault();var a=e(this),r='<option value="#SITEID#">#SITENAME#</option>';e.post("site/getSiteNames",{sportId:a.val(),siteStatus:"1"},function(t){var a=t.data,i="";if(1==t.code){i+='<option value="">请选择</option>';for(var s=0;s<a.siteNames.length;s++)i+=r.replace("#SITENAME#",a.siteNames[s].siteName).replace("#SITEID#",a.siteNames[s].siteId);e("#reservations_fixed_siteId").html(i)}else console.log(t.message||"查询场地失败, 请稍后重试"),alert(t.message||"查询场地失败, 请稍后重试")})}),e(".reservations-list").on("click",".reservations-delete",function(a){a.preventDefault();for(var r=e(this).parents("tr.reservations-list-item"),i=r.attr("data-date"),s=r.attr("data-site"),n=t.opts.data.siteReserveDateList,o=0;o<n.length;o++)if(n[o].reserveStartDate==i&&n[o].siteReserveTimeList[0].siteId==s){t.opts.data.siteReserveDateList.splice(o,1);break}r.remove(),t.calculateSiteMoney()}),e("#reservations_fixed_add").on("click",function(a){a.preventDefault();var r=e("#reservations_fixed_form"),i=e(".reservations-list"),s={};if(!r.valid())return!1;var n=t.opts.data;n.mobile=e("#reservations_fixed_mobile").val(),n.name=e("#reservations_fixed_name").val(),n.memberId=e("#reservations_fixed_member").val()||"0",n.opType=e("#reservations_fixed_opType").val(),s.reserveStartDate=e("#reservations_fixed_date").val(),s.reserveEndDate=e("#reservations_fixed_date").val(),s.reserveWeek=t.formatWeek(s.reserveStartDate),s.siteReserveTimeList=[{siteStartTime:e("#reservations_fixed_start").val(),siteEndTime:e("#reservations_fixed_end").val(),siteId:e("#reservations_fixed_siteId").val()}],n.siteReserveDateList.push(s),i.append(t.tpl.BlockBooking().replace("#BOOKING_SPORT#",e("#reservations_fixed_site").find("option:selected").text().trim()).replace(/#BOOKING_START_DATE#/g,e("#reservations_fixed_date").val()).replace("#BOOKING_START_TIME#",e("#reservations_fixed_start").val()).replace("#BOOKING_END_TIME#",e("#reservations_fixed_end").val()).replace("#BOOKING_AREA#",e("#reservations_fixed_siteId").find("option:selected").text().trim()).replace("#BOOKING_SITE#",e("#reservations_fixed_siteId").val())),t.calculateSiteMoney()}),e("#reservations_fixed_confirm").on("click",function(a){a.preventDefault();var r=e(".reservations-list");return 1==r.find("tr").size()?(alert("请先加场"),!1):void e.post("site/saveReservationSite",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?(e("#reservations_paid_order").val(a.orderId),e("#zhifuModal").modal({backdrop:!1,show:!0})):alert(t.message||"提交预订失败, 请稍后重试")})}),e("#reservations_paid_confirm").on("click",function(t){t.preventDefault();var a=e("#reservations_paid_form"),r=a.serialize();return!("submitting"==a.attr("submitting")||!a.valid())&&(a.attr("submitting","submitting"),void e.post("/site/confirmOrder",r,function(t){a.attr("submitting",""),1==t.code?(e("#zhifuModal").modal("hide"),e("#tips_success_modal").modal({show:!0,backdrop:!1}),setTimeout(function(){e("#tips_success_modal").modal("hide"),location.reload()},3e3)):alert(t.message||"确认订单失败, 请稍后重试")}))})}};a.init()}(jQuery,moment);