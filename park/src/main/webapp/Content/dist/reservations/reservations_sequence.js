!function(e,t){var a={opts:{STATUS:0,ORDERED:1,LOCKED:2,REFRESHED:3,Current_Date:e("#current_date").val(),Current_Sport:e("#current_sport").val(),Reservation_Tpl:"<span>#USERNAME#</span><span>#USERMOBILE#</span>",Reservation_Date_Tpl:'<li class="reservation-date-picker #DATEACTIVE#" data-value="#DATEVALUE#"><a href="javascript:;">#DATETEXT#</a></li>',Reservation_list:'<li class="court">#SITENAME# #STARTTIME#-#ENDTIME#</li>'},init:function(){this.initDatePicker(),this.initMenuDate(),this.loadReservations(),this.initSequenceEvents(),this.initMenuButtons(),this.initReservationsSteps()},initDatePicker:function(){var t=this;e.datetimepicker.setLocale("zh"),e("#other_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",defaultDate:new Date,onSelectDate:function(a,s){t.opts.Current_Date=s.val(),e(".sequence-date").find(".reservation-date-picker[data-value='"+t.opts.Current_Date+"']").addClass("active").siblings().removeClass("active"),t.loadReservations()}}),e(".other-date-calendar").on("click",function(t){t.preventDefault(),e("#other_date").datetimepicker("show")})},initMenuDate:function(){for(var a,s=this,r=t(s.opts.Current_Date),o=["周日","周一","周二","周三","周四","周五","周六"],i=[],n=r.weekday(),l=1-n;l<=7-n;l++)r=t(s.opts.Current_Date),r.add(l,"d"),a=r.format("e")==n?"今天":r.format("e")==n+1?"明天":r.format("e")==n-1?"昨天":o[r.format("e")],i.push(s.opts.Reservation_Date_Tpl.replace(/#DATEACTIVE#/,"今天"!=a?"":"active").replace(/#DATEVALUE#/,r.format("YYYY-MM-DD")).replace(/#DATETEXT#/,a+"("+r.format("MM-DD")+")"));e(".other-date-select").before(i.join("")),e(".sequence-date").on("click",".reservation-date-picker",function(t){t.preventDefault();var a=e(this);a.hasClass("active")||(a.addClass("active").siblings().removeClass("active"),s.opts.Current_Date=a.attr("data-value"),s.loadReservations())}),e(".show-orders-btn .btn").on("click",function(t){t.preventDefault();var a=e(this);"显示"===a.text()?(a.text("隐藏"),e(".show-orders-list").show()):(a.text("显示"),e(".show-orders-list").hide())})},loadReservations:function(){var a=this,s=e(".sequence-show");s.find("tr.timing-body td:not(.time)").removeClass();var r=t();if(a.opts.Current_Date===r.format("YYYY-MM-DD")){var o=r.format("HH:ss");s.find("tr.timing-body").each(function(t,a){var s=e(a).attr("data-start");o>=s&&e(a).find("td:not(.time)").removeClass().addClass("disabled").addClass("time-end").html("")})}a.opts.Current_Date<r.format("YYYY-MM-DD")&&s.find("tr.timing-body").find("td:not(.time)").removeClass().addClass("disabled").addClass("time-end").html(""),e.post("/site/dynamicSiteReservation",{siteDate:a.opts.Current_Date,sportId:a.opts.Current_Sport},function(t){var s=t.data;if(1==t.code)for(var r=s.siteInfos,o=0;o<r.length;o++)for(var i=r[o],n=i.reserveInfos,l=0;l<n.length;l++){var d=n[l],c=e('[data-id="'+i.siteId+'"][data-start="'+d.startTime+'"][data-end="'+d.endTime+'"]');1==d.siteReserveStatus&&(1==d.reserveType?c.removeClass().addClass("ordered computer").html(a.opts.Reservation_Tpl.replace(/#USERNAME#/,d.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+d.operatorMobile.substr(-4))):2==d.reserveType?c.removeClass().addClass("ordered mobile").html(a.opts.Reservation_Tpl.replace(/#USERNAME#/,d.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+d.operatorMobile.substr(-4))):3==d.reserveType&&c.removeClass().addClass("ordered phone").html(a.opts.Reservation_Tpl.replace(/#USERNAME#/,d.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+d.operatorMobile.substr(-4)))),2==d.siteReserveStatus&&(1==d.reserveType?c.removeClass().addClass("unpaid computer").html(a.opts.Reservation_Tpl.replace(/#USERNAME#/,d.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,"*"+d.operatorMobile.substr(-4))):2==d.reserveType?c.removeClass().addClass("unpaid mobile").html(a.opts.Reservation_Tpl.replace(/#USERNAME#/,d.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,"*"+d.operatorMobile.substr(-4))):3==d.reserveType&&c.removeClass().addClass("unpaid phone").html(a.opts.Reservation_Tpl.replace(/#USERNAME#/,d.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,"*"+d.operatorMobile.substr(-4)))),3==d.siteReserveStatus&&c.removeClass().addClass("locked").html(""),4==d.siteReserveStatus&&c.removeClass().addClass("disabled").html(""),5!=d.siteReserveStatus||c.hasClass("time-end")||c.removeClass().addClass("null").html("")}else alert(t.message||"查询预订信息失败, 请稍后重试")})},addReservationsSelected:function(t){var a,s=this,r=e(".sequence-show"),o=e(".show-orders-list"),i=o.find(".selected-booking"),n="";if(t===s.opts.ORDERED&&(a=r.find("td.selected"),e(".sequence-order").attr("data-click","yes").show(),e(".sequence-lock").attr("data-click","yes").show(),e(".sequence-unlock").attr("data-click","no").hide(),e(".sequence-refresh").attr("data-click","no").show()),t===s.opts.REFRESHED&&(a=r.find("td.sel"),e(".sequence-order").attr("data-click","no").show(),e(".sequence-lock").attr("data-click","no").show(),e(".sequence-unlock").attr("data-click","no").hide(),e(".sequence-refresh").attr("data-click","yes").show()),t===s.opts.LOCKED&&(a=r.find("td.sel"),e(".sequence-order").attr("data-click","no").show(),e(".sequence-lock").attr("data-click","no").hide(),e(".sequence-unlock").attr("data-click","yes").show(),e(".sequence-refresh").attr("data-click","no").show()),i.find(".court").remove(),0===a.size())return void i.find(".none").show();for(var l=null,d=0,c={},v=0;v<a.size();v++)l=a.eq(v),d=a.eq(v).attr("data-col"),c["cols"+d]?c["cols"+d].push(a.eq(v).attr("data-startTime")):c["cols"+d]=[],n+=s.opts.Reservation_list.replace("#SITENAME#",l.attr("data-name")).replace("#STARTTIME#",l.attr("data-start")).replace("#ENDTIME#",l.attr("data-end"));i.find(".none").hide(),i.append(n),o.find(".court-display .number").text(a.size())},initSequenceEvents:function(){var t=this,a=e(".sequence-show");a.on("mouseover","tr.timing-body td:not(.time)",function(t){t.preventDefault();var a=e(this);a.parents("tr").addClass("active").siblings().removeClass("active"),a.parents("table").find("[data-col='"+a.attr("data-col")+"']").addClass("active").siblings().removeClass("active")}),a.on("click","td.null",function(a){a.preventDefault();var s=e(this);s.addClass("selected").removeClass("null").html(""),t.addReservationsSelected(t.opts.ORDERED)}),a.on("click","td.selected",function(a){a.preventDefault();var s=e(this);s.addClass("null").removeClass("selected").html(""),t.addReservationsSelected(t.opts.ORDERED)}),a.on("click","td.ordered,td.unpaid",function(a){a.preventDefault();var s=e(this);s.addClass("sel"),t.addReservationsSelected(t.opts.REFRESHED)}),a.on("click","td.locked",function(a){a.preventDefault();var s=e(this);s.addClass("sel"),t.addReservationsSelected(t.opts.LOCKED)}),a.on("click","td.sel",function(a){a.preventDefault();var s=e(this);s.removeClass("sel"),t.addReservationsSelected(t.opts.LOCKED)})},findReservationsSelected:function(t){var a,s=this,r=e(".sequence-show"),o=[];if(t===s.opts.ORDERED&&(r.find("td.sel").removeClass("sel"),a=r.find("td.selected")),t===s.opts.REFRESHED&&(r.find("td.locked.sel").removeClass("sel"),a=r.find("td.sel")),t===s.opts.LOCKED&&(r.find("td.ordered.sel").removeClass("sel"),r.find("td.unpaid.sel").removeClass("sel"),a=r.find("td.sel")),0===a.size())return o;for(var i=0;i<a.size();i++){var n=a.eq(i);o.push({siteStartTime:n.attr("data-start"),siteEndTime:n.attr("data-end"),siteId:n.attr("data-id")})}return o},initMenuButtons:function(){var t=this,a=e("#zhifuModal");e(".sequence-lock").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return alert("当前不能锁定场地");var r=t.findReservationsSelected(t.opts.ORDERED);return 0===r.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:new Date(t.opts.Current_Date).getDay()||7,siteReserveTimeList:r}]},void e.post("/site/lockSite",{siteOperationJson:JSON.stringify(t.opts.data),lock:!0},function(t){1==t.code?e(".tips-modal").modal({backdrop:!1,show:!0}):alert(t.message||"锁场失败, 请稍后重试")}))}),e(".sequence-unlock").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return alert("当前不能解锁场地");var r=t.findReservationsSelected(t.opts.LOCKED);return 0===r.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:new Date(t.opts.Current_Date).getDay()||7,siteReserveTimeList:r}]},void e.post("/site/lockSite",{siteOperationJson:JSON.stringify(t.opts.data),lock:!1},function(t){1==t.code?e(".tips-modal").modal({backdrop:!1,show:!0}):alert(t.message||"解锁失败, 请稍后重试")}))}),e(".sequence-order").on("click",function(s){s.preventDefault();var r=e(this);if("no"===r.attr("data-click"))return alert("当前不能预订场地");var o=t.findReservationsSelected(t.opts.ORDERED);return 0===o.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:new Date(t.opts.Current_Date).getDay()||7,siteReserveTimeList:o}]},e.post("/site/calculateSiteMoney",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?e("#reservations_amount").val(a.originalPrice):alert(t.message||"计算金额失败, 请稍后重试")}),void a.modal({backdrop:!1,show:!0}))}),e(".sequence-refresh").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return alert("当前不能调换场地");var r=t.findReservationsSelected(t.opts.REFRESHED);return 0===r.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:new Date(t.opts.Current_Date).getDay()||7,siteReserveTimeList:r}]},void e.post("",{siteOperationJson:JSON.stringify(t.opts.data),lock:!0},function(t){1==t.code?e(".tips-modal").modal({backdrop:!1,show:!0}):alert(t.message||"锁场失败, 请稍后重试")}))})},initReservationsSteps:function(){var t=this,a=e("#zhifuModal");a.find(".reservations-steps").steps({enableFinishButton:!1,enablePagination:!1,enableAllSteps:!1}),e(".reservations-pay").on("click",function(s){s.preventDefault(),a.find(".reservations-steps").steps("next",1);var r=t.opts.data;r.name=e("#reservations_name").val(),r.mobile=e("#reservations_mobile").val(),r.opType="2",r.reserveType="1",r.reserveModel="1",e.post("/site/saveReservationSite",{siteOperationJson:JSON.stringify(r)},function(t){var s=t.data;1==t.code?(e("#reservations_order_id").val(s.orderId),e("#reservations_order_no").val(s.orderNo),a.find(".reservations-steps").steps("next",1)):alert(t.message||"提交预订失败, 请稍后重试")})}),e(".reservations-pay-confirm").on("click",function(s){s.preventDefault();var r=e("#reservations_paid_form"),o=r.serialize();return!("submitting"==r.attr("submitting")||!r.valid())&&(r.attr("submitting","submitting"),void e.post("/site/confirmOrder",o,function(e){r.attr("submitting",""),1==e.code?(a.modal("hide"),t.loadReservations()):alert(e.message||"确认订单失败, 请稍后重试")}))}),e("#reservations_name").autosuggest({url:"/member/searchMember",method:"post",queryParamName:"search",dataCallback:function(e){var t=e.data,a=[];if(1==e.code){if(t&&t.members&&t.members.length>0){for(var s=0;s<t.members.length;s++)a.push({id:t.members[s].memberMobile,label:t.members[s].memberId,value:t.members[s].memberName});return a}return[]}return alert("搜索会员失败, 请稍后重试"),[]},onSelect:function(t){var a=t.data("label"),s=t.data("id");e("#reservations_member").val(a),e("#reservations_mobile").val(s)}})}};a.init()}(jQuery,moment);