!function(e,t){var a={opts:{STATUS:0,ORDERED:1,LOCKED:2,REFRESHED:3,ATTENTION:4,Current_Date:e("#current_date").val(),Current_Sport:e("#current_sport").val(),Current_Week_Date:[],Reservation_Tpl:'<span class="name" data-id="#USERID#" data-name="#USERNAME#">#USERNAME1#</span><span class="mobile" data-mobile="#USERMOBILE#" data-card="#CARDNO#">#USERMOBILE1#</span><span class="angle" data-reserve="#RESERVETIMEID#"></span>',Reservation_Date_Tpl:'<li class="reservation-date-picker #DATEACTIVE#" data-value="#DATEVALUE#"><a href="javascript:;">#DATETEXT#</a></li>',Reservation_list:'<li class="court">#SITENAME# #STARTTIME#-#ENDTIME#</li>'},init:function(){this.initDatePicker(),this.initMenuDate(),this.loadReservations(),this.initSequenceEvents(),this.initMenuButtons(),this.initReservationsSteps(),this.changePaidMoney()},initDatePicker:function(){var t=this;e.datetimepicker.setLocale("zh"),e("#other_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",defaultDate:new Date,onSelectDate:function(a,s){t.opts.Current_Date=s.val(),t.opts.Current_Week_Date.indexOf(t.opts.Current_Date)>-1?e(".sequence-date").find(".reservation-date-picker[data-value='"+t.opts.Current_Date+"']").addClass("active").siblings().removeClass("active"):e(".sequence-date").find(".reservation-date-picker").removeClass("active"),t.loadReservations()}}),e(".other-date-calendar").on("click",function(t){t.preventDefault(),e("#other_date").datetimepicker("show")})},formatWeek:function(e){var a=t(e).format("e");return"0"!=a?a:7},initMenuDate:function(){for(var a,s=this,r=t(s.opts.Current_Date),n=["周日","周一","周二","周三","周四","周五","周六"],i=[],o=parseInt(r.format("e")),l=1;l<=7;l++)r=t(s.opts.Current_Date),l<o?r.subtract(o-l,"d"):r.add(l-o,"d"),a=r.format("e")==o?"今天":n[r.format("e")],i.push(s.opts.Reservation_Date_Tpl.replace(/#DATEACTIVE#/,"今天"!=a?"":"active").replace(/#DATEVALUE#/,r.format("YYYY-MM-DD")).replace(/#DATETEXT#/,a+"("+r.format("MM-DD")+")")),s.opts.Current_Week_Date.push(r.format("YYYY-MM-DD"));e(".other-date-select").before(i.join("")),e(".sequence-date").on("click",".reservation-date-picker",function(t){t.preventDefault();var a=e(this);a.hasClass("active")||(a.addClass("active").siblings().removeClass("active"),s.opts.Current_Date=a.attr("data-value"),e("#other_date").val(s.opts.Current_Date),s.loadReservations())});var d=e(".show-orders-btn"),c=e(".show-orders-list"),v=d.draggabilly({axis:"x"}),u=d.find(".btn");v.on("dragStart",function(){d.css("position","fixed"),c.hide()}),v.on("dragEnd",function(e,t){d.css("position","fixed"),c.css("left",t.x-200+"px"),"显示"===u.text()?c.hide():c.show()}),v.on("staticClick",function(){"显示"===u.text()?(u.text("隐藏"),c.show()):(u.text("显示"),c.hide())}),d.css("position","fixed")},loadReservations:function(){var a=this,s=e(".sequence-show");s.find("tr.timing-body td:not(.time)").removeClass();var r=t();if(a.opts.Current_Date===r.format("YYYY-MM-DD")){var n=r.format("HH:00");s.find("tr.timing-body").each(function(t,a){var s=e(a).attr("data-start");n>s&&e(a).find("td:not(.time)").removeClass().addClass("disabled").addClass("time-end").html("")})}a.opts.Current_Date<r.format("YYYY-MM-DD")&&s.find("tr.timing-body").find("td:not(.time)").removeClass().addClass("disabled").addClass("time-end").html(""),e.post("/site/dynamicSiteReservation",{siteDate:a.opts.Current_Date,sportId:a.opts.Current_Sport},function(t){var s=t.data;if(1==t.code)for(var r=s.siteInfos,n=0;n<r.length;n++)for(var i=r[n],o=i.reserveInfos,l=0;l<o.length;l++){var d=o[l],c=e('[data-id="'+i.siteId+'"][data-start="'+d.startTime+'"][data-end="'+d.endTime+'"]'),v="";1==d.siteReserveStatus&&(v=a.opts.Reservation_Tpl.replace(/#RESERVETIMEID#/,d.reserveTimeId||"").replace(/#CARDNO#/,d.cardNo||"").replace(/#USERID#/,d.operatorId).replace(/#USERNAME#/,d.operatorName).replace(/#USERNAME1#/,d.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,d.operatorMobile).replace(/#USERMOBILE1#/,"*"+d.operatorMobile.substr(-4)),1==d.reserveType?c.removeClass().addClass("ordered computer").html(v):2==d.reserveType?c.removeClass().addClass("ordered mobile").html(v):3==d.reserveType&&c.removeClass().addClass("ordered phone").html(v),1==d.isUse&&c.addClass("signed"),2==d.isUse&&c.addClass("used")),2==d.siteReserveStatus&&(v=a.opts.Reservation_Tpl.replace(/#RESERVETIMEID#/,d.reserveTimeId||"").replace(/#CARDNO#/,d.cardNo||"").replace(/#USERID#/,d.operatorId).replace(/#USERNAME#/,d.operatorName).replace(/#USERNAME1#/,d.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,d.operatorMobile).replace(/#USERMOBILE1#/,"*"+d.operatorMobile.substr(-4)),1==d.reserveType?c.removeClass().addClass("unpaid computer").html(v):2==d.reserveType?c.removeClass().addClass("unpaid mobile").html(v):3==d.reserveType&&c.removeClass().addClass("unpaid phone").html(v),1==d.isUse&&c.addClass("signed"),2==d.isUse&&c.addClass("used")),3==d.siteReserveStatus&&c.removeClass().addClass("locked").html(""),4==d.siteReserveStatus&&c.removeClass().addClass("disabled").html(""),5!=d.siteReserveStatus||c.hasClass("time-end")||c.removeClass().addClass("null").html("")}else e.logConsole("查询预订信息失败",t.message),e.tipsWarningAlert("查询预订信息失败")})},addReservationsSelected:function(t){var a,s=this,r=e(".sequence-show"),n=e(".show-orders-list"),i=n.find(".selected-booking"),o="";if(t===s.opts.ORDERED&&(a=r.find("td.selected"),e(".sequence-order").attr("data-click","yes").show(),e(".sequence-lock").attr("data-click","yes").show(),e(".sequence-unlock").attr("data-click","no").hide(),e(".sequence-refresh").attr("data-click","no").hide(),e(".sequence-attention").attr("data-click","no").hide()),t===s.opts.REFRESHED&&(a=r.find("td.sel"),e(".sequence-order").attr("data-click","no").hide(),e(".sequence-lock").attr("data-click","no").hide(),e(".sequence-unlock").attr("data-click","no").hide(),e(".sequence-refresh").attr("data-click","no").hide(),e(".sequence-attention").attr("data-click","yes").show()),t===s.opts.LOCKED&&(a=r.find("td.sel"),e(".sequence-order").attr("data-click","no").hide(),e(".sequence-lock").attr("data-click","no").hide(),e(".sequence-unlock").attr("data-click","yes").show(),e(".sequence-refresh").attr("data-click","no").hide(),e(".sequence-attention").attr("data-click","no").hide()),i.find(".court").remove(),0===a.size())return void i.find(".none").show();a=a.sort(function(t,a){return e(t).attr("data-col")-e(a).attr("data-col")});for(var l=[],d=null,c=0;c<a.size();c++)d=a.eq(c),l.push({siteName:d.attr("data-name"),startTime:d.attr("data-start"),endTime:d.attr("data-end")});for(var v=1;v<l.length;v++)l[v-1].siteName==l[v].siteName&&l[v-1].endTime==l[v].startTime&&(l[v-1].endTime=l[v].endTime,l.splice(v,1),v--);for(var u=0;u<l.length;u++)o+=s.opts.Reservation_list.replace("#SITENAME#",l[u].siteName).replace("#STARTTIME#",l[u].startTime).replace("#ENDTIME#",l[u].endTime);i.find(".none").hide(),i.append(o),n.find(".court-display .number").text(a.size())},initSequenceEvents:function(){var t=this,a=e(".sequence-show");a.on("mouseover","tr.timing-body td:not(.time)",function(t){t.preventDefault();var a=e(this);a.parents("tr").addClass("active").siblings().removeClass("active"),a.parents("table").find("[data-col='"+a.attr("data-col")+"']").addClass("active").siblings().removeClass("active")}),a.on("click","td.null",function(a){a.preventDefault();var s=e(this);s.addClass("selected").removeClass("null").html(""),t.addReservationsSelected(t.opts.ORDERED)}),a.on("click","td.selected",function(a){a.preventDefault();var s=e(this);s.addClass("null").removeClass("selected").html(""),t.addReservationsSelected(t.opts.ORDERED)}),a.on("click","td.ordered,td.unpaid",function(s){s.preventDefault();var r=e(this);a.find("td.selected").addClass("null").removeClass("selected").html(""),r.addClass("sel");for(var n,i=null,o=a.find("td.sel"),l=0;l<o.size();l++)if(i=o.eq(l),n||(n=i.find("span.mobile").attr("data-mobile")),i.find("span.mobile").attr("data-mobile")!==n)return e.tipsWarningAlert("请选择相同人的预订场地"),void r.addClass("sel").removeClass("sel");t.addReservationsSelected(t.opts.REFRESHED)}),a.on("click","td.locked",function(s){s.preventDefault();var r=e(this);a.find("td.selected").addClass("null").removeClass("selected").html(""),r.addClass("sel"),t.addReservationsSelected(t.opts.LOCKED)}),a.on("click","td.sel",function(a){a.preventDefault();var s=e(this);s.removeClass("sel"),t.addReservationsSelected(t.opts.LOCKED)})},findReservationsSelected:function(t){var a,s=this,r=e(".sequence-show"),n=[];if(t===s.opts.ORDERED&&(r.find("td.sel").removeClass("sel"),a=r.find("td.selected")),t===s.opts.REFRESHED&&(r.find("td.locked.sel").removeClass("sel"),a=r.find("td.sel")),t===s.opts.LOCKED&&(r.find("td.ordered.sel").removeClass("sel"),r.find("td.unpaid.sel").removeClass("sel"),a=r.find("td.sel")),0===a.size())return n;for(var i=0;i<a.size();i++){var o=a.eq(i);n.push({siteStartTime:o.attr("data-start"),siteEndTime:o.attr("data-end"),siteId:o.attr("data-id"),mobile:o.find("span.mobile").attr("data-mobile"),name:o.find("span.name").attr("data-name"),member:o.find("span.name").attr("data-id"),card:o.find("span.mobile").attr("data-card"),timeId:o.find("span.angle").attr("data-reserve")})}return n},initMenuButtons:function(){var t=this,a=e("#pay_model");e(".sequence-lock").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return e.tipsWarningAlert("当前不能锁定场地");var r=t.findReservationsSelected(t.opts.ORDERED);return 0===r.length?e.tipsWarningAlert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:t.formatWeek(t.opts.Current_Date),siteReserveTimeList:r}]},void e.post("/site/lockSite",{siteOperationJson:JSON.stringify(t.opts.data),lock:!0},function(a){1==a.code?(t.loadReservations(),e.tipsSuccessAlert("您已经成功锁定这些场地！")):(e.logConsole("锁场失败",a.message),e.tipsWarningAlert("锁场失败"))}))}),e(".sequence-unlock").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return e.tipsWarningAlert("当前不能解锁场地");var r=t.findReservationsSelected(t.opts.LOCKED);return 0===r.length?e.tipsWarningAlert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:t.formatWeek(t.opts.Current_Date),siteReserveTimeList:r}]},void e.post("/site/lockSite",{siteOperationJson:JSON.stringify(t.opts.data),lock:!1},function(a){1==a.code?(t.loadReservations(),e.tipsSuccessAlert("您已经成功解锁这些场地！")):(e.logConsole("解锁失败",a.message),e.tipsWarningAlert("解锁失败"))}))}),e(".sequence-order").on("click",function(s){s.preventDefault();var r=e(this);if("no"===r.attr("data-click"))return e.tipsWarningAlert("当前不能预订场地");var n=t.findReservationsSelected(t.opts.ORDERED);return 0===n.length?e.tipsWarningAlert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:t.formatWeek(t.opts.Current_Date),siteReserveTimeList:n}]},e.post("/site/calculateSiteMoney",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?(e("#reservations_user_amount").val(a.originalPrice),e("#reservations_paid_orderSumCount").val(a.sumNums),e("#reservations_paid_orderSumPrice").val(a.originalPrice),e("#reservations_paid_payCount").val(a.sumNums),e("#reservations_paid_paySumPrice").val(a.originalPrice),e("#reservations_paid_money").val(a.originalPrice)):(e.logConsole("计算金额失败",t.message),e.tipsWarningAlert("计算金额失败"))}),a.modal({backdrop:!1,show:!0}),e("#reservations_user_name").val(""),void e("#reservations_user_mobile").val(""))}),e(".sequence-refresh").on("click",function(e){return e.preventDefault(),!1}),e(".sequence-attention").on("click",function(a){a.preventDefault();var s=t.findReservationsSelected(t.opts.REFRESHED);return 0===s.length?e.tipsWarningAlert("请先选择场地"):(e("#attention_user_name").val(s[0].name),e("#attention_user_mobile").val(s[0].mobile),e("#attention_user_opType").val(s[0].member>0?"1":"2"),e("#attention_user_id").val(s[0].member),e("#attention_user_card").val(s[0].card),void e("#attentionModal").modal({backdrop:!1,show:!0}))}),e("#attention_user_confirm").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return e.tipsWarningAlert("当前不能开场");var r=t.findReservationsSelected(t.opts.REFRESHED),n=[];if(0===r.length)return e.tipsWarningAlert("请先选择场地");for(var i=0;i<r.length;i++)n.push(r[i].timeId);e.post("/memberSign/memberSign",{signType:e("#attention_user_opType").val(),signMobile:e("#attention_user_mobile").val(),signName:e("#attention_user_name").val(),signMemberCardNo:e("#attention_user_card").val(),reserveTimeIds:n.join(","),signDate:t.opts.Current_Date,memberId:e("#attention_user_id").val()},function(t){1==t.code?(e("#attentionModal").modal("hide"),location.reload()):(e.logConsole("签到开场失败",t.message),e.tipsWarningAlert("签到开场失败"))})})},initReservationsSteps:function(){var t=this,a=e("#pay_model");e("#reservations_pay_order").on("click",function(s){function r(a){var s=e("#reservations_user_form");if("submitting"===s.attr("submitting")||!s.valid())return!1;s.attr("submitting","submitting");var r=t.opts.data;r.name=e("#reservations_user_name").val(),r.mobile=e("#reservations_user_mobile").val(),r.memberId=e("#reservations_user_member").val()||"0",r.opType=e("#reservations_user_opType").val(),r.reserveType="1",r.reserveModel="1",e.post("/site/saveReservationSite",{siteOperationJson:JSON.stringify(r)},function(t){s.attr("submitting","");var r=t.data;1==t.code?(e("#reservations_paid_order").val(r.orderId),a()):(e.logConsole("提交预订失败",t.message),e.tipsWarningAlert("提交预订失败"))})}function n(){var s=e("#reservations_paid_form"),r=s.serialize();return!("submitting"==s.attr("submitting")||!s.valid())&&(s.attr("submitting","submitting"),void e.post("/site/confirmOrder",r,function(r){s.attr("submitting",""),1==r.code?(t.loadReservations(),e.tipsSuccessAlert("预订支付成功！",function(){a.modal("hide")})):(e.logConsole("确认订单失败",r.message),e.tipsWarningAlert("确认订单失败"))}))}s.preventDefault(),r(n)}),e("#reservations_user_name").autosuggest({url:"/member/searchMember",method:"post",queryParamName:"search",dataCallback:function(a){var s=a.data,r=[];if(1==a.code){if(s&&s.members&&s.members.length>0){for(var n=0;n<s.members.length;n++)r.push({id:s.members[n].memberMobile,label:s.members[n].memberId,value:s.members[n].memberName+"("+s.members[n].cardTypeName+")"});return r}return e("#reservations_user_member").val("0"),e("#reservations_user_opType").val("2"),t.queryMemberBalance(0),[]}return e.logConsole("搜索会员失败",a.message),e.tipsWarningAlert("搜索会员失败"),[]},onSelect:function(a){var s=a.data("label"),r=a.data("id"),n=a.data("value");e("#reservations_user_member").val(s),e("#reservations_user_mobile").val(r),e("#reservations_user_opType").val("1"),e("#reservations_user_name").val(n.replace(/\(.+\)/,"")),t.queryMemberBalance(s)}})},queryMemberBalance:function(t){return t?void e.post("/member/memberDetail",{memberId:t},function(t){var a=t.data,s=e("#reservations_paid_money").val();1==t.code?(e("#reservations_paid_balance").val(a.cardBalance),a.cardBalance>=s?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(s-a.cardBalance)):(e.logConsole("会员余额查询失败",t.message),e.tipsWarningAlert("会员余额查询失败"))}):void e("#reservations_paid_balance").val("您还不是会员")},changePaidMoney:function(){e("#reservations_paid_paySumPrice").on("change",function(t){t.preventDefault();var a=e("#reservations_paid_balance").val(),s=e(this).val();a=parseFloat(a).toFixed(2),s=parseFloat(s).toFixed(2),a>=s?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(s-a)})}};a.init()}(jQuery,moment);