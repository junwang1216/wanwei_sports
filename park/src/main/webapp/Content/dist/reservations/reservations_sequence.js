!function(e,t){var a={tpl:{show:function(){return"<span>#USERNAME#</span><span>#USERMOBILE#</span>"}},opts:{Current_Date:e("#current_date").val(),Current_Sport:e("#current_sport").val(),Reservation_Tpl:"<span>#USERNAME#</span><span>#USERMOBILE#</span>",Reservation_Date_Tpl:'<li class="reservation-date-picker #DATEACTIVE#" data-value="#DATEVALUE#"><a href="javascript:;">#DATETEXT#</a></li>'},init:function(){this.initDatePicker(),this.initMenuDate(),this.loadReservations(),this.initSequenceEvents(),this.initMenuButtons(),this.initReservationsSteps()},initDatePicker:function(){var t=this;e.datetimepicker.setLocale("zh"),e("#other_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",inline:!0,maxDate:0,onSelectDate:function(a,r){t.opts.Current_Date=r.val(),e(".other-date .icon-text").text(t.opts.Current_Date),t.loadReservations(),e(".other-date-calendar").hide()}}),e(".other-date").on("click",function(t){t.preventDefault(),e(".other-date-calendar").is(":visible")?e(".other-date-calendar").hide():e(".other-date-calendar").show()})},initMenuDate:function(){var a=this,r=t(a.opts.Current_Date),s=["周日","周一","周二","周三","周四","周五","周六"],o=[];o.push(a.opts.Reservation_Date_Tpl.replace(/#DATEACTIVE#/,"active").replace(/#DATEVALUE#/,r.format("YYYY-MM-DD")).replace(/#DATETEXT#/,"今天("+r.format("MM-DD")+")"));for(var i=0;i<6;i++)r.add(1,"d"),o.push(a.opts.Reservation_Date_Tpl.replace(/#DATEACTIVE#/,"").replace(/#DATEVALUE#/,r.format("YYYY-MM-DD")).replace(/#DATETEXT#/,(0!==i?s[r.format("e")]:"明天")+"("+r.format("MM-DD")+")"));e(".other-date-select").before(o.join("")),e(".sequence-date").on("click",".reservation-date-picker",function(t){t.preventDefault();var r=e(this);r.hasClass("active")||(r.addClass("active").siblings().removeClass("active"),a.opts.Current_Date=r.attr("data-value"),a.loadReservations())})},loadReservations:function(){var t=this;e.post("/site/dynamicSiteReservation",{siteDate:t.opts.Current_Date,sportId:t.opts.Current_Sport},function(a){var r=a.data;if(1==a.code)for(var s=r.siteInfos,o=0;o<s.length;o++)for(var i=s[o],n=i.reserveInfos,l=0;l<n.length;l++){var p=n[l],d=e('[data-id="'+i.siteId+'"][data-start="'+p.startTime+'"][data-end="'+p.endTime+'"]');1==p.siteReserveStatus&&(1==p.reserveType?d.removeClass().addClass("ordered computer").html(t.opts.Reservation_Tpl.replace(/#USERNAME#/,p.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+p.operatorMobile.substr(-4))):2==p.reserveType?d.removeClass().addClass("ordered mobile").html(t.opts.Reservation_Tpl.replace(/#USERNAME#/,p.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+p.operatorMobile.substr(-4))):3==p.reserveType&&d.removeClass().addClass("ordered phone").html(t.opts.Reservation_Tpl.replace(/#USERNAME#/,p.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+p.operatorMobile.substr(-4)))),2==p.siteReserveStatus&&(1==p.reserveType?d.removeClass().addClass("unpaid computer").html(t.opts.Reservation_Tpl.replace(/#USERNAME#/,p.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+p.operatorMobile.substr(-4))):2==p.reserveType?d.removeClass().addClass("unpaid mobile").html(t.opts.Reservation_Tpl.replace(/#USERNAME#/,p.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+p.operatorMobile.substr(-4))):3==p.reserveType&&d.removeClass().addClass("unpaid phone").html(t.opts.Reservation_Tpl.replace(/#USERNAME#/,p.operatorName.substr(1)+"*").replace(/#USERMOBILE#/,"*"+p.operatorMobile.substr(-4)))),3==p.siteReserveStatus&&d.removeClass().addClass("locked").html(""),4==p.siteReserveStatus&&d.removeClass().addClass("disabled").html(""),5==p.siteReserveStatus&&d.removeClass().addClass("null").html("")}else alert(a.message||"查询预订信息失败, 请稍后重试")})},initSequenceEvents:function(){var t=e(".sequence-show");t.on("click","td.null",function(t){t.preventDefault();var a=e(this);a.addClass("selected").removeClass("null").html("")}),t.on("click","td.selected",function(t){t.preventDefault();var a=e(this);a.addClass("null").removeClass("selected").html("")})},initMenuButtons:function(){function t(){var t=e(".sequence-show"),a=t.find("td.selected"),r=[];if(0===a.size())return r;for(var s=0;s<a.size();s++){var o=a.eq(s);r.push({siteStartTime:o.attr("data-start"),siteEndTime:o.attr("data-end"),siteId:o.attr("data-id")})}return r}var a=this,r=e("#zhifuModal");e(".sequence-lock").on("click",function(t){t.preventDefault(),e(".tips-modal").modal({backdrop:!1,show:!0})}),e(".sequence-order").on("click",function(s){s.preventDefault();var o=t();return 0===o.length?alert("请选择场地"):(a.opts.data={siteReserveDateList:[{reserveStartDate:a.opts.Current_Date,reserveEndDate:a.opts.Current_Date,reserveWeek:new Date(a.opts.Current_Date).getDay()||7,siteReserveTimeList:o}]},e.post("/site/calculateSiteMoney",{siteOperationJson:JSON.stringify(a.opts.data)},function(t){var a=t.data;1==t.code?e("#reservations_amount").val(a.originalPrice):alert(t.message||"计算金额失败, 请稍后重试")}),void r.modal({backdrop:!1,show:!0}))})},initReservationsSteps:function(){var t=this,a=e("#zhifuModal");a.find(".reservations-steps").steps({enableFinishButton:!1,enablePagination:!1,enableAllSteps:!1}),e(".reservations-pay").on("click",function(r){r.preventDefault(),a.find(".reservations-steps").steps("next",1);var s=t.opts.data;s.name=e("#reservations_name").val(),s.mobile=e("#reservations_mobile").val(),s.opType="2",s.reserveType="1",s.reserveModel="1",e.post("/site/saveReservationSite",{siteOperationJson:JSON.stringify(s)},function(t){var r=t.data;1==t.code?(e("#reservations_order_id").val(r.orderId),e("#reservations_order_no").val(r.orderNo),a.find(".reservations-steps").steps("next",1)):alert(t.message||"提交预订失败, 请稍后重试")})}),e(".reservations-pay-confirm").on("click",function(r){r.preventDefault();var s=e("#reservations_paid_form"),o=s.serialize();return!("submitting"==s.attr("submitting")||!s.valid())&&(s.attr("submitting","submitting"),void e.post("/site/confirmOrder",o,function(e){s.attr("submitting",""),1==e.code?(a.modal("hide"),t.loadReservations()):alert(e.message||"确认订单失败, 请稍后重试")}))})}};a.init()}(jQuery,moment);