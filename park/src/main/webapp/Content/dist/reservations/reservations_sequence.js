!function(e,t){var a={opts:{STATUS:0,ORDERED:1,LOCKED:2,REFRESHED:3,ATTENTION:4,Current_Date:e("#current_date").val(),Current_Sport:e("#current_sport").val(),Reservation_Tpl:'<span class="name" data-id="#USERID#" data-name="#USERNAME#">#USERNAME1#</span><span class="mobile" data-mobile="#USERMOBILE#" data-card="#CARDNO#">#USERMOBILE1#</span><span class="angle" data-reserve="#RESERVETIMEID#"></span>',Reservation_Date_Tpl:'<li class="reservation-date-picker #DATEACTIVE#" data-value="#DATEVALUE#"><a href="javascript:;">#DATETEXT#</a></li>',Reservation_list:'<li class="court">#SITENAME# #STARTTIME#-#ENDTIME#</li>'},init:function(){this.initDatePicker(),this.initMenuDate(),this.loadReservations(),this.initSequenceEvents(),this.initMenuButtons(),this.initReservationsSteps(),this.changePaidMoney()},initDatePicker:function(){var t=this;e.datetimepicker.setLocale("zh"),e("#other_date").datetimepicker({timepicker:!1,lang:"zh",format:"Y-m-d",defaultDate:new Date,onSelectDate:function(a,s){t.opts.Current_Date=s.val(),e(".sequence-date").find(".reservation-date-picker[data-value='"+t.opts.Current_Date+"']").addClass("active").siblings().removeClass("active"),t.loadReservations()}}),e(".other-date-calendar").on("click",function(t){t.preventDefault(),e("#other_date").datetimepicker("show")})},formatWeek:function(e){var a=t(e).format("e");return"0"!=a?a:7},initMenuDate:function(){for(var a,s=this,r=t(s.opts.Current_Date),i=["周日","周一","周二","周三","周四","周五","周六"],n=[],o=r.weekday(),d=0;d<7;d++)r=t(s.opts.Current_Date),r.add(d,"d"),a=r.format("e")==o?"今天":i[r.format("e")],n.push(s.opts.Reservation_Date_Tpl.replace(/#DATEACTIVE#/,"今天"!=a?"":"active").replace(/#DATEVALUE#/,r.format("YYYY-MM-DD")).replace(/#DATETEXT#/,a+"("+r.format("MM-DD")+")"));e(".other-date-select").before(n.join("")),e(".sequence-date").on("click",".reservation-date-picker",function(t){t.preventDefault();var a=e(this);a.hasClass("active")||(a.addClass("active").siblings().removeClass("active"),s.opts.Current_Date=a.attr("data-value"),s.loadReservations())}),e(".show-orders-btn .btn").on("click",function(t){t.preventDefault();var a=e(this);"显示"===a.text()?(a.text("隐藏"),e(".show-orders-list").show()):(a.text("显示"),e(".show-orders-list").hide())})},loadReservations:function(){var a=this,s=e(".sequence-show");s.find("tr.timing-body td:not(.time)").removeClass();var r=t();if(a.opts.Current_Date===r.format("YYYY-MM-DD")){var i=r.format("HH:00");s.find("tr.timing-body").each(function(t,a){var s=e(a).attr("data-start");i>s&&e(a).find("td:not(.time)").removeClass().addClass("disabled").addClass("time-end").html("")})}a.opts.Current_Date<r.format("YYYY-MM-DD")&&s.find("tr.timing-body").find("td:not(.time)").removeClass().addClass("disabled").addClass("time-end").html(""),e.post("/site/dynamicSiteReservation",{siteDate:a.opts.Current_Date,sportId:a.opts.Current_Sport},function(t){var s=t.data;if(1==t.code)for(var r=s.siteInfos,i=0;i<r.length;i++)for(var n=r[i],o=n.reserveInfos,d=0;d<o.length;d++){var l=o[d],c=e('[data-id="'+n.siteId+'"][data-start="'+l.startTime+'"][data-end="'+l.endTime+'"]'),v="";1==l.siteReserveStatus&&(v=a.opts.Reservation_Tpl.replace(/#RESERVETIMEID#/,l.reserveTimeId||"").replace(/#CARDNO#/,l.cardNo||"").replace(/#USERID#/,l.operatorId).replace(/#USERNAME#/,l.operatorName).replace(/#USERNAME1#/,l.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,l.operatorMobile).replace(/#USERMOBILE1#/,"*"+l.operatorMobile.substr(-4)),1==l.reserveType?c.removeClass().addClass("ordered computer").html(v):2==l.reserveType?c.removeClass().addClass("ordered mobile").html(v):3==l.reserveType&&c.removeClass().addClass("ordered phone").html(v),1==l.isUse&&c.addClass("signed"),2==l.isUse&&c.addClass("used")),2==l.siteReserveStatus&&(v=a.opts.Reservation_Tpl.replace(/#RESERVETIMEID#/,l.reserveTimeId||"").replace(/#CARDNO#/,l.cardNo||"").replace(/#USERID#/,l.operatorId).replace(/#USERNAME#/,l.operatorName).replace(/#USERNAME1#/,l.operatorName.substr(0,2)+"*").replace(/#USERMOBILE#/,l.operatorMobile).replace(/#USERMOBILE1#/,"*"+l.operatorMobile.substr(-4)),1==l.reserveType?c.removeClass().addClass("unpaid computer").html(v):2==l.reserveType?c.removeClass().addClass("unpaid mobile").html(v):3==l.reserveType&&c.removeClass().addClass("unpaid phone").html(v),1==l.isUse&&c.addClass("signed"),2==l.isUse&&c.addClass("used")),3==l.siteReserveStatus&&c.removeClass().addClass("locked").html(""),4==l.siteReserveStatus&&c.removeClass().addClass("disabled").html(""),5!=l.siteReserveStatus||c.hasClass("time-end")||c.removeClass().addClass("null").html("")}else alert(t.message||"查询预订信息失败, 请稍后重试")})},addReservationsSelected:function(t){var a,s=this,r=e(".sequence-show"),i=e(".show-orders-list"),n=i.find(".selected-booking"),o="";if(t===s.opts.ORDERED&&(a=r.find("td.selected"),e(".sequence-order").attr("data-click","yes").show(),e(".sequence-lock").attr("data-click","yes").show(),e(".sequence-unlock").attr("data-click","no").hide(),e(".sequence-refresh").attr("data-click","no").hide(),e(".sequence-attention").attr("data-click","no").hide()),t===s.opts.REFRESHED&&(a=r.find("td.sel"),e(".sequence-order").attr("data-click","no").hide(),e(".sequence-lock").attr("data-click","no").hide(),e(".sequence-unlock").attr("data-click","no").hide(),e(".sequence-refresh").attr("data-click","no").hide(),e(".sequence-attention").attr("data-click","yes").show()),t===s.opts.LOCKED&&(a=r.find("td.sel"),e(".sequence-order").attr("data-click","no").hide(),e(".sequence-lock").attr("data-click","no").hide(),e(".sequence-unlock").attr("data-click","yes").show(),e(".sequence-refresh").attr("data-click","no").hide(),e(".sequence-attention").attr("data-click","no").hide()),n.find(".court").remove(),0===a.size())return void n.find(".none").show();for(var d=null,l=0;l<a.size();l++)d=a.eq(l),o+=s.opts.Reservation_list.replace("#SITENAME#",d.attr("data-name")).replace("#STARTTIME#",d.attr("data-start")).replace("#ENDTIME#",d.attr("data-end"));n.find(".none").hide(),n.append(o),i.find(".court-display .number").text(a.size())},initSequenceEvents:function(){var t=this,a=e(".sequence-show");a.on("mouseover","tr.timing-body td:not(.time)",function(t){t.preventDefault();var a=e(this);a.parents("tr").addClass("active").siblings().removeClass("active"),a.parents("table").find("[data-col='"+a.attr("data-col")+"']").addClass("active").siblings().removeClass("active")}),a.on("click","td.null",function(a){a.preventDefault();var s=e(this);s.addClass("selected").removeClass("null").html(""),t.addReservationsSelected(t.opts.ORDERED)}),a.on("click","td.selected",function(a){a.preventDefault();var s=e(this);s.addClass("null").removeClass("selected").html(""),t.addReservationsSelected(t.opts.ORDERED)}),a.on("click","td.ordered,td.unpaid",function(s){s.preventDefault();var r=e(this);a.find("td.selected").addClass("null").removeClass("selected").html(""),r.addClass("sel");for(var i,n=null,o=a.find("td.sel"),d=0;d<o.size();d++)if(n=o.eq(d),i||(i=n.find("span.mobile").attr("data-mobile")),n.find("span.mobile").attr("data-mobile")!==i)return alert("请选择相同人的预订场地"),void r.addClass("sel").removeClass("sel");t.addReservationsSelected(t.opts.REFRESHED)}),a.on("click","td.locked",function(s){s.preventDefault();var r=e(this);a.find("td.selected").addClass("null").removeClass("selected").html(""),r.addClass("sel"),t.addReservationsSelected(t.opts.LOCKED)}),a.on("click","td.sel",function(a){a.preventDefault();var s=e(this);s.removeClass("sel"),t.addReservationsSelected(t.opts.LOCKED)})},findReservationsSelected:function(t){var a,s=this,r=e(".sequence-show"),i=[];if(t===s.opts.ORDERED&&(r.find("td.sel").removeClass("sel"),a=r.find("td.selected")),t===s.opts.REFRESHED&&(r.find("td.locked.sel").removeClass("sel"),a=r.find("td.sel")),t===s.opts.LOCKED&&(r.find("td.ordered.sel").removeClass("sel"),r.find("td.unpaid.sel").removeClass("sel"),a=r.find("td.sel")),0===a.size())return i;for(var n=0;n<a.size();n++){var o=a.eq(n);i.push({siteStartTime:o.attr("data-start"),siteEndTime:o.attr("data-end"),siteId:o.attr("data-id"),mobile:o.find("span.mobile").attr("data-mobile"),name:o.find("span.name").attr("data-name"),member:o.find("span.name").attr("data-id"),card:o.find("span.mobile").attr("data-card"),timeId:o.find("span.angle").attr("data-reserve")})}return i},initMenuButtons:function(){var t=this,a=e("#zhifuModal");e(".sequence-lock").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return alert("当前不能锁定场地");var r=t.findReservationsSelected(t.opts.ORDERED);return 0===r.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:t.formatWeek(t.opts.Current_Date),siteReserveTimeList:r}]},void e.post("/site/lockSite",{siteOperationJson:JSON.stringify(t.opts.data),lock:!0},function(a){1==a.code?(e(".tips-modal").modal({backdrop:!1,show:!0}).find(".text-message").text("您已经成功锁定这些场地。"),setTimeout(function(){e(".tips-modal").modal("hide"),t.loadReservations()},3e3)):alert(a.message||"锁场失败, 请稍后重试")}))}),e(".sequence-unlock").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return alert("当前不能解锁场地");var r=t.findReservationsSelected(t.opts.LOCKED);return 0===r.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:t.formatWeek(t.opts.Current_Date),siteReserveTimeList:r}]},void e.post("/site/lockSite",{siteOperationJson:JSON.stringify(t.opts.data),lock:!1},function(a){1==a.code?(e(".tips-modal").modal({backdrop:!1,show:!0}).find(".text-message").text("您已经成功解锁这些场地。"),setTimeout(function(){e(".tips-modal").modal("hide"),t.loadReservations()},3e3)):alert(a.message||"解锁失败, 请稍后重试")}))}),e(".sequence-order").on("click",function(s){s.preventDefault();var r=e(this);if("no"===r.attr("data-click"))return alert("当前不能预订场地");var i=t.findReservationsSelected(t.opts.ORDERED);return 0===i.length?alert("请先选择场地"):(t.opts.data={siteReserveDateList:[{reserveStartDate:t.opts.Current_Date,reserveEndDate:t.opts.Current_Date,reserveWeek:t.formatWeek(t.opts.Current_Date),siteReserveTimeList:i}]},e.post("/site/calculateSiteMoney",{siteOperationJson:JSON.stringify(t.opts.data)},function(t){var a=t.data;1==t.code?(e("#reservations_user_amount").val(a.originalPrice),e("#reservations_paid_orderSumCount").val(a.sumNums),e("#reservations_paid_orderSumPrice").val(a.originalPrice),e("#reservations_paid_payCount").val(a.sumNums),e("#reservations_paid_paySumPrice").val(a.originalPrice),e("#reservations_paid_money").val(a.originalPrice)):alert(t.message||"计算金额失败, 请稍后重试")}),a.modal({backdrop:!1,show:!0}),a.find(".reservations-steps").steps("previous",1),e("#reservations_user_name").val("散客"),void e("#reservations_user_mobile").val(""))}),e(".sequence-refresh").on("click",function(e){return e.preventDefault(),!1}),e(".sequence-attention").on("click",function(a){a.preventDefault();var s=t.findReservationsSelected(t.opts.REFRESHED);return 0===s.length?alert("请先选择场地"):(e("#attention_user_name").val(s[0].name),e("#attention_user_mobile").val(s[0].mobile),e("#attention_user_opType").val(s[0].member>0?"1":"2"),e("#attention_user_id").val(s[0].member),e("#attention_user_card").val(s[0].card),void e("#attentionModal").modal({backdrop:!1,show:!0}))}),e("#attention_user_confirm").on("click",function(a){a.preventDefault();var s=e(this);if("no"===s.attr("data-click"))return alert("当前不能开场");var r=t.findReservationsSelected(t.opts.REFRESHED),i=[];if(0===r.length)return alert("请先选择场地");for(var n=0;n<r.length;n++)i.push(r[n].timeId);e.post("/memberSign/memberSign",{signType:e("#attention_user_opType").val(),signMobile:e("#attention_user_mobile").val(),signName:e("#attention_user_name").val(),signMemberCardNo:e("#attention_user_card").val(),reserveTimeIds:i.join(","),signDate:t.opts.Current_Date,memberId:e("#attention_user_id").val()},function(t){1==t.code?(e("#attentionModal").modal("hide"),location.reload()):alert(t.message||"签到开场失败, 请稍后重试")})})},initReservationsSteps:function(){var t=this,a=e("#zhifuModal");a.find(".reservations-steps").steps({enableFinishButton:!1,enablePagination:!1,enableAllSteps:!1}),e("#reservations_user_pay").on("click",function(s){s.preventDefault();var r=e("#reservations_user_form");if("submitting"===r.attr("submitting")||!r.valid())return!1;r.attr("submitting","submitting");var i=t.opts.data;i.name=e("#reservations_user_name").val(),i.mobile=e("#reservations_user_mobile").val(),i.memberId=e("#reservations_user_member").val()||"0",i.opType=e("#reservations_user_opType").val(),i.reserveType="1",i.reserveModel="1",e.post("/site/saveReservationSite",{siteOperationJson:JSON.stringify(i)},function(t){r.attr("submitting","");var s=t.data;1==t.code?(e("#reservations_paid_order").val(s.orderId),a.find(".reservations-steps").steps("next",1)):alert(t.message||"提交预订失败, 请稍后重试")})}),e("#reservations_paid_confirm").on("click",function(s){s.preventDefault();var r=e("#reservations_paid_form"),i=r.serialize();return!("submitting"==r.attr("submitting")||!r.valid())&&(r.attr("submitting","submitting"),void e.post("/site/confirmOrder",i,function(e){r.attr("submitting",""),1==e.code?(a.modal("hide"),t.loadReservations()):alert(e.message||"确认订单失败, 请稍后重试")}))}),e("#reservations_user_name").autosuggest({url:"/member/searchMember",method:"post",queryParamName:"search",dataCallback:function(a){var s=a.data,r=[];if(1==a.code){if(s&&s.members&&s.members.length>0){for(var i=0;i<s.members.length;i++)r.push({id:s.members[i].memberMobile,label:s.members[i].memberId,value:s.members[i].memberName+"("+s.members[i].cardTypeName+")"});return r}return e("#reservations_user_member").val("0"),e("#reservations_user_mobile").val(""),e("#reservations_user_opType").val("2"),t.queryMemberBalance(0),[]}return alert("搜索会员失败, 请稍后重试"),[]},onSelect:function(a){var s=a.data("label"),r=a.data("id"),i=a.data("value");e("#reservations_user_member").val(s),e("#reservations_user_mobile").val(r),e("#reservations_user_opType").val("1"),e("#reservations_user_name").val(i.replace(/\(.+\)/,"")),t.queryMemberBalance(s)}})},queryMemberBalance:function(t){return t?(e("#reservations_paid_balance").parents(".form-group").show(),void e.post("/member/memberDetail",{memberId:t},function(t){var a=t.data,s=e("#reservations_paid_money").val();1==t.code?(e("#reservations_paid_balance").val(a.cardBalance),a.cardBalance>=s?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(s-a.cardBalance)):alert(t.message||"会员余额查询失败, 请稍后重试")})):void e("#reservations_paid_balance").val("0.00").parents(".form-group").hide()},changePaidMoney:function(){e("#reservations_paid_paySumPrice").on("change",function(t){t.preventDefault();var a=e("#reservations_paid_balance").val(),s=e(this).val();a=parseFloat(a).toFixed(2),s=parseFloat(s).toFixed(2),a>=s?e("#reservations_paid_money").val("0.00"):e("#reservations_paid_money").val(s-a)})}};a.init()}(jQuery,moment);